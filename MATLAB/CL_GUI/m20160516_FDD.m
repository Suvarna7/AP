%% FDD algorithm. Kamuran Turksoy
function [fault,fault_reason]=m20160516_FDD(y,fault,fault_reason)
dcc=cell(5,1);
dcc(1,1)={[0.274725274725275,0.241758241758242,0.208791208791209,0.175824175824176,0.142857142857143,0.109890109890110,0.0769230769230769,0.0439560439560440,0.0109890109890110,-0.0219780219780220,-0.0549450549450549,-0.0879120879120879,-0.120879120879121;0.241758241758242,0.214285714285714,0.186813186813187,0.159340659340659,0.131868131868132,0.104395604395604,0.0769230769230769,0.0494505494505495,0.0219780219780220,-0.00549450549450549,-0.0329670329670330,-0.0604395604395604,-0.0879120879120879;0.208791208791209,0.186813186813187,0.164835164835165,0.142857142857143,0.120879120879121,0.0989010989010989,0.0769230769230769,0.0549450549450550,0.0329670329670330,0.0109890109890110,-0.0109890109890110,-0.0329670329670330,-0.0549450549450549;0.175824175824176,0.159340659340659,0.142857142857143,0.126373626373626,0.109890109890110,0.0934065934065934,0.0769230769230769,0.0604395604395605,0.0439560439560440,0.0274725274725275,0.0109890109890110,-0.00549450549450549,-0.0219780219780220;0.142857142857143,0.131868131868132,0.120879120879121,0.109890109890110,0.0989010989010989,0.0879120879120879,0.0769230769230769,0.0659340659340659,0.0549450549450550,0.0439560439560440,0.0329670329670330,0.0219780219780220,0.0109890109890110;0.109890109890110,0.104395604395604,0.0989010989010989,0.0934065934065934,0.0879120879120879,0.0824175824175824,0.0769230769230769,0.0714285714285714,0.0659340659340659,0.0604395604395605,0.0549450549450550,0.0494505494505495,0.0439560439560440;0.0769230769230769,0.0769230769230769,0.0769230769230769,0.0769230769230769,0.0769230769230769,0.0769230769230769,0.0769230769230769,0.0769230769230769,0.0769230769230769,0.0769230769230769,0.0769230769230769,0.0769230769230769,0.0769230769230769;0.0439560439560440,0.0494505494505495,0.0549450549450550,0.0604395604395605,0.0659340659340659,0.0714285714285714,0.0769230769230769,0.0824175824175824,0.0879120879120879,0.0934065934065934,0.0989010989010989,0.104395604395604,0.109890109890110;0.0109890109890110,0.0219780219780220,0.0329670329670330,0.0439560439560440,0.0549450549450550,0.0659340659340659,0.0769230769230769,0.0879120879120879,0.0989010989010989,0.109890109890110,0.120879120879121,0.131868131868132,0.142857142857143;-0.0219780219780220,-0.00549450549450549,0.0109890109890110,0.0274725274725275,0.0439560439560440,0.0604395604395605,0.0769230769230769,0.0934065934065934,0.109890109890110,0.126373626373626,0.142857142857143,0.159340659340659,0.175824175824176;-0.0549450549450549,-0.0329670329670330,-0.0109890109890110,0.0109890109890110,0.0329670329670330,0.0549450549450550,0.0769230769230769,0.0989010989010989,0.120879120879121,0.142857142857143,0.164835164835165,0.186813186813187,0.208791208791209;-0.0879120879120879,-0.0604395604395604,-0.0329670329670330,-0.00549450549450549,0.0219780219780220,0.0494505494505495,0.0769230769230769,0.104395604395604,0.131868131868132,0.159340659340659,0.186813186813187,0.214285714285714,0.241758241758242;-0.120879120879121,-0.0879120879120879,-0.0549450549450549,-0.0219780219780220,0.0109890109890110,0.0439560439560440,0.0769230769230769,0.109890109890110,0.142857142857143,0.175824175824176,0.208791208791209,0.241758241758242,0.274725274725275]};
dcc(2,1)={[-0.0329670329670330,-0.0329670329670330,-0.0329670329670330,-0.0329670329670330,-0.0329670329670330,-0.0329670329670330,-0.0329670329670330,-0.0329670329670330,-0.0329670329670330,-0.0329670329670330,-0.0329670329670330,-0.0329670329670330,-0.0329670329670330;-0.0274725274725275,-0.0274725274725275,-0.0274725274725275,-0.0274725274725275,-0.0274725274725275,-0.0274725274725275,-0.0274725274725275,-0.0274725274725275,-0.0274725274725275,-0.0274725274725275,-0.0274725274725275,-0.0274725274725275,-0.0274725274725275;-0.0219780219780220,-0.0219780219780220,-0.0219780219780220,-0.0219780219780220,-0.0219780219780220,-0.0219780219780220,-0.0219780219780220,-0.0219780219780220,-0.0219780219780220,-0.0219780219780220,-0.0219780219780220,-0.0219780219780220,-0.0219780219780220;-0.0164835164835165,-0.0164835164835165,-0.0164835164835165,-0.0164835164835165,-0.0164835164835165,-0.0164835164835165,-0.0164835164835165,-0.0164835164835165,-0.0164835164835165,-0.0164835164835165,-0.0164835164835165,-0.0164835164835165,-0.0164835164835165;-0.0109890109890110,-0.0109890109890110,-0.0109890109890110,-0.0109890109890110,-0.0109890109890110,-0.0109890109890110,-0.0109890109890110,-0.0109890109890110,-0.0109890109890110,-0.0109890109890110,-0.0109890109890110,-0.0109890109890110,-0.0109890109890110;-0.00549450549450549,-0.00549450549450549,-0.00549450549450549,-0.00549450549450549,-0.00549450549450549,-0.00549450549450549,-0.00549450549450549,-0.00549450549450549,-0.00549450549450549,-0.00549450549450549,-0.00549450549450549,-0.00549450549450549,-0.00549450549450549;0,0,0,0,0,0,0,0,0,0,0,0,0;0.00549450549450549,0.00549450549450549,0.00549450549450549,0.00549450549450549,0.00549450549450549,0.00549450549450549,0.00549450549450549,0.00549450549450549,0.00549450549450549,0.00549450549450549,0.00549450549450549,0.00549450549450549,0.00549450549450549;0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110;0.0164835164835165,0.0164835164835165,0.0164835164835165,0.0164835164835165,0.0164835164835165,0.0164835164835165,0.0164835164835165,0.0164835164835165,0.0164835164835165,0.0164835164835165,0.0164835164835165,0.0164835164835165,0.0164835164835165;0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220;0.0274725274725275,0.0274725274725275,0.0274725274725275,0.0274725274725275,0.0274725274725275,0.0274725274725275,0.0274725274725275,0.0274725274725275,0.0274725274725275,0.0274725274725275,0.0274725274725275,0.0274725274725275,0.0274725274725275;0.0329670329670330,0.0329670329670330,0.0329670329670330,0.0329670329670330,0.0329670329670330,0.0329670329670330,0.0329670329670330,0.0329670329670330,0.0329670329670330,0.0329670329670330,0.0329670329670330,0.0329670329670330,0.0329670329670330]};
dcc(3,1)={[0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220;0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110;0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200;-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500;-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999;-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130;-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140;-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130,-0.0129870129870130;-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999,-0.00999000999000999;-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500,-0.00499500499500500;0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200,0.00199800199800200;0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110,0.0109890109890110;0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220,0.0219780219780220]};
dcc(4,1)={[-0.0192307692307692,-0.0192307692307692,-0.0192307692307692,-0.0192307692307692,-0.0192307692307692,-0.0192307692307692,-0.0192307692307692,-0.0192307692307692,-0.0192307692307692,-0.0192307692307692,-0.0192307692307692,-0.0192307692307692,-0.0192307692307692;1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17,1.06752213906265e-17;0.0104895104895105,0.0104895104895105,0.0104895104895105,0.0104895104895105,0.0104895104895105,0.0104895104895105,0.0104895104895105,0.0104895104895105,0.0104895104895105,0.0104895104895105,0.0104895104895105,0.0104895104895105,0.0104895104895105;0.0139860139860140,0.0139860139860140,0.0139860139860140,0.0139860139860140,0.0139860139860140,0.0139860139860140,0.0139860139860140,0.0139860139860140,0.0139860139860140,0.0139860139860140,0.0139860139860140,0.0139860139860140,0.0139860139860140;0.0122377622377622,0.0122377622377622,0.0122377622377622,0.0122377622377622,0.0122377622377622,0.0122377622377622,0.0122377622377622,0.0122377622377622,0.0122377622377622,0.0122377622377622,0.0122377622377622,0.0122377622377622,0.0122377622377622;0.00699300699300699,0.00699300699300699,0.00699300699300699,0.00699300699300699,0.00699300699300699,0.00699300699300699,0.00699300699300699,0.00699300699300699,0.00699300699300699,0.00699300699300699,0.00699300699300699,0.00699300699300699,0.00699300699300699;0,0,0,0,0,0,0,0,0,0,0,0,0;-0.00699300699300699,-0.00699300699300699,-0.00699300699300699,-0.00699300699300699,-0.00699300699300699,-0.00699300699300699,-0.00699300699300699,-0.00699300699300699,-0.00699300699300699,-0.00699300699300699,-0.00699300699300699,-0.00699300699300699,-0.00699300699300699;-0.0122377622377622,-0.0122377622377622,-0.0122377622377622,-0.0122377622377622,-0.0122377622377622,-0.0122377622377622,-0.0122377622377622,-0.0122377622377622,-0.0122377622377622,-0.0122377622377622,-0.0122377622377622,-0.0122377622377622,-0.0122377622377622;-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140,-0.0139860139860140;-0.0104895104895105,-0.0104895104895105,-0.0104895104895105,-0.0104895104895105,-0.0104895104895105,-0.0104895104895105,-0.0104895104895105,-0.0104895104895105,-0.0104895104895105,-0.0104895104895105,-0.0104895104895105,-0.0104895104895105,-0.0104895104895105;-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17,-1.06752213906265e-17;0.0192307692307692,0.0192307692307692,0.0192307692307692,0.0192307692307692,0.0192307692307692,0.0192307692307692,0.0192307692307692,0.0192307692307692,0.0192307692307692,0.0192307692307692,0.0192307692307692,0.0192307692307692,0.0192307692307692]};
dcc(5,1)={[0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262;-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842;-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315;-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052;0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403;0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543;0.0172768408062526,0.0172768408062526,0.0172768408062526,0.0172768408062526,0.0172768408062526,0.0172768408062526,0.0172768408062526,0.0172768408062526,0.0172768408062526,0.0172768408062526,0.0172768408062526,0.0172768408062526,0.0172768408062526;0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543,0.0131633072809543;0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403,0.00226244343891403;-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052,-0.0111065405183052;-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315,-0.0197449609214315;-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842,-0.0135746606334842;0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262,0.0203619909502262]};

loadings=[0.430051530136990;-0.213432785959098;-0.555842126842058;0.641983333264418;-0.219997857132687];
lamdas=[2.19772843392574];
lamda_rest=[1.82511796079264;0.601721056311122;0.374138383963187;0.00129416500731333];
mX=[154.149138686479,-0.0929715326306836,-0.0416625315472671,-0.0100582392128598,0.00286037652413469];
sX=[25.9179212378803,3.30062609844723,0.359445448128125,0.177457068434294,0.0725576808787546];
np=[1];


alpT=1-1e-2;
alpQ=1-1e-2;
Tlimit=finv(alpT,np,288-np);
Q1=0;Q2=0;Q3=0;
for ii=1:length(lamda_rest)
    Q1=Q1+lamda_rest(ii);
    Q2=Q2+lamda_rest(ii)^2;
    Q3=Q3+lamda_rest(ii)^3;
end
h0=1-(2*Q1*Q3/(3*Q2^2));
c1=norminv(alpQ);
if h0<0
    c1=-c1;
end
Qlimit=Q1*(1-(Q2*h0*(1-h0)/Q1^2)+c1*(2*Q2*h0^2)^0.5/Q1)^(1/h0);

Xtest=[y(end,1)...
    m20151015_sgolay_smooth_derivative_fast([y(end-6:end,1);m20160516_calculate_pred(y(end-1:end))],1,13,1,dcc{2,1})...
    m20151015_sgolay_smooth_derivative_fast([y(end-6:end,1);m20160516_calculate_pred(y(end-1:end))],2,13,2,dcc{3,1})...
    m20151015_sgolay_smooth_derivative_fast([y(end-6:end,1);m20160516_calculate_pred(y(end-1:end))],3,13,3,dcc{4,1})...
    m20151015_sgolay_smooth_derivative_fast([y(end-6:end,1);m20160516_calculate_pred(y(end-1:end))],4,13,4,dcc{5,1})];
nXtest=zeros(1,5);
for kk=1:5
    nXtest(1,kk)=(Xtest(1,kk)-mX(:,kk))/sX(:,kk);
end

T=(nXtest*loadings)/diag(lamdas)*(nXtest*loadings)';
Q=nXtest*(eye(5)-loadings*loadings')*nXtest';
Tcont=((nXtest*loadings)/diag(lamdas.^0.5)*(loadings)').^2;
Qcont=(nXtest*(eye(5)-loadings*loadings')).^2;

if T>Tlimit
    fault=cat(1,fault,1);
    fault_reason=cat(1,fault_reason,Tcont);
elseif Q>Qlimit
    fault=cat(1,fault,2);
    fault_reason=cat(1,fault_reason,Qcont);
else
    fault=cat(1,fault,0);
    fault_reason=cat(1,fault_reason,zeros(1,5));
end